# AnyAI Scoring 改修計画（2025-10-14更新）

この文書は Scoring 機能に関する性能改善とリライアビリティ向上の実装計画のみを扱います。Interview/Cleansing/Dashboard など他モジュールの計画は `plans_bu.md` を参照。

---

## 1. 目的
- LLM 呼び出しを中心としたスコアリング処理のスループットを向上させつつ、失敗時の再実行と途中継続を robust にする。
- 入力シートの規模に依存しない実行時間を目指し、大規模データでも均一な体感速度を提供する。

---

## 2. 実装テーマとタスク

- 送信（LLM 呼び出し）・レスポンス検証（JSON schema / スコア整形）・書き込み（Google Sheets）を独立タスク化し、`asyncio.Queue` を使ってストリーミングで連携。テキスト/Video スコアリングとも共通パイプラインで稼働中（`app/scoring_pipeline.py` + `JobManager.run_job`）。
- 429 レートリミット対応の並列数調整ロジックを新パイプライン前提で再設計。Video/Retry もパイプライン経由に切り替え済みで、残課題は例外伝播と停止処理の統一。
- チェックポイント（`checkpoint.json`）更新タイミングをパイプライン末尾（検証完了時）へ移動する方針を定義済み。現在は `mark_unit_completed` コールバックで適用。

### 2.2 LLM レスポンス検証ワーカー
- JSON スキーマ検証やフォールバック判定をスレッド／プロセスワーカーにオフロード。
- メインループは LLM I/O に専念し、CPU バウンドな検証は `asyncio.to_thread` もしくは専用 `ThreadPoolExecutor` で処理。

### 2.3 パーシャル結果のストリーミング書き込み
- バッチ完了を待たずに、一定件数・一定時間ごとに Sheets へ `batch_update`（テキストモードで暫定パラメータ `flush_interval=2s` / `flush_unit_threshold=sheet_chunk_rows` を実装）。
- 書き込みは専用ワーカーが担当し、メイン処理からは `(row, col_offset, score[])` をキュー投入するだけにする。
- 書き込み失敗時は再試行し、重複更新を避けるための idempotent なバッファを設計（GoogleSheetsError のリトライは未完、フォールバックを今後検討）。

### 2.4 LLM キャッシュの導入
- 入力（発話 + カテゴリ定義 + system prompt）をハッシュ化し、スコア配列をローカルキャッシュ（JSON）に保存（`runs/scoring/cache.json`）。✅
- 再実行や同一セルの再試行時にはキャッシュを優先し、LLM 呼び出し回数を削減。✅
- TTL・上限件数・キャッシュヒット率のメトリクスを記録（ヒット率出力は今後の改善項目）。

### 2.5 500 行チャンク分割と自動再実行
- 入力シートを 500 行単位でチャンク化し、各チャンクを独立ジョブとしてキューイング。
- 各チャンク終了時点で結果を Sheets に反映。失敗チャンクのみ自動再実行（一定回数で諦め、エラー表示）。
- 親ジョブのメタデータにはチャンクごとの状態（pending/running/completed/failed）を保持し、UI/再開APIから参照できるようにする。
- 現状：`RunConfig` にチャンク設定を追加し、`chunk_meta.json` でチャンク状態を記録。チャンク再実行ロジック（バックオフ/上限）の実装を完了。並列チャンク処理や UI 連携は今後対応。

---

## 3. 作業ロードマップ（Scoring 限定）
| 項目 | 期待成果 | 状態 |
|------|-----------|------|
| スコアリング問い合わせの非同期パイプライン | 送信・検証・書き込みを分離し、I/O 待機時間を圧縮 | 🚧 Video/Retry 統合完了、例外ハンドリング整備中 |
| LLM レスポンス検証ワーカー | CPU バウンド処理をオフロードし、メインループの待ち時間を削減 | ⏳ 設計中 |
| ストリーミング書き込み | パーシャル結果を即時反映し、完了までの待ち時間を短縮 | 🚧 テキストモードで初期実装 |
| LLM キャッシュ | 再試行や類似入力の応答を高速化 | ✅ 基盤導入済み（TTL/最大件数/無効化フラグ実装） |
| 500 行チャンク分割 & 再実行 | 大規模シートでも一定の処理時間にし、部分失敗時の再実行コストを最小化 | ✅ 初期実装完了（再実行ロジック入り） |

---

## 4. 直近のアクション
1. 非同期パイプライン拡張：Video モードと再試行フェーズを新パイプラインへ統合済み。今後は例外伝播と停止シグナルを整理し、リカバリ時のクリーンアップを検証。
   - 429/エラー発生時の停止処理をキュー経由に統一する実装（`_terminate`・`None` シグナルの送出）を追加。
   - リソースクリーンアップが失敗ケースやキャンセル時にも漏れなく動くかをテスト。
2. Validation/SheetWriter ワーカー設計：スレッドプール/タイムアウト/リトライ方針を固める。
3. 親ジョブ集約と UI 連携：チャンク完了集約・Queue API の拡張、進捗表示更新。
4. キャッシュ統計の可視化要否を判断し、必要ならメトリクス記録を追加。

---

## 5. 参照ファイル（予定）
- `app/worker.py`：ジョブ実行ループ、チャンクスケジューラ、パイプライン各ステージ。
- `app/services/scoring.py`：LLM 呼び出しインタフェース（キャッシュ対応）。
- `app/services/google_sheets.py`：部分更新処理の拡張。
- `app/models.py`：チャンク情報やパイプライン設定値の追加。
- `runs/<job_id>/...`：チャンクメタとキャッシュファイル配置。

---

## 6. リスクと対策
| リスク | 内容 | 対策 |
|--------|------|------|
| 非同期化による race condition | 競合で checkpoint が壊れる可能性 | Lock とタスク間キューで順序制御、単体テスト整備 |
| Sheets API 制限 | ストリーミング更新がレートリミットに触れる可能性 | チャンク＆書き込みワーカーでまとめ書き、リトライポリシー実装 |
| キャッシュ不整合 | 古いスコアを返す恐れ | TTL + スコア生成日時の記録、キャッシュ無効化トグル |
| チャンク再実行ループ | 常に失敗するチャンクが無限再試行になる | リトライ上限・エラー通知を設ける |

---

## 7. ハンドオフメモ
- サービスアカウント `anyagent-cep@anyai-playground.iam.gserviceaccount.com` の権限確認は既存ロジックを流用。
- ログとメタ情報は `runs/scoring/` 以下に整理する予定（チャンク別ディレクトリ + キャッシュファイル）。
- 完了後は README の Scoring セクションと UI のヘルプテキスト更新が必要。
