<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png">
  <title>AnyAI Comment Enhancer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/anyai/core/anyai.tokens.css">
  <link rel="stylesheet" href="/static/anyai/core/anyai.components.css">
  <link rel="stylesheet" href="/static/anyai/core/anyai.utilities.css">
  <link rel="stylesheet" href="/static/anyai/tool-layout.css">
  <script src="/static/anyai/loading-overlay.js"></script>
  <script defer src="/static/anyai/vendor/lucide.js"></script>
  <script defer src="/static/anyai/sidebar.js"></script>
  <script defer src="/static/anyai/core/anyai.js"></script>
  <script defer src="/static/anyai/queue-manager.js"></script>
  <style>
    #log-container {
      height: 320px;
      overflow-y: auto;
      font-family: var(--anyai-font-mono, 'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace);
      font-size: 0.9rem;
      white-space: pre-wrap;
      background: var(--anyai-bg-subtle);
      padding: var(--anyai-space-4);
      border-radius: var(--anyai-radius-2);
      border: 1px solid var(--anyai-border);
    }

    .queue-card {
      gap: var(--anyai-space-4);
    }

    .queue-header { display:flex; justify-content:space-between; align-items:center; gap:var(--anyai-space-4); }
    .queue-header-actions { display:flex; gap:var(--anyai-space-2); }
    .queue-content { display:flex; gap:var(--anyai-space-4); flex:1; min-height:220px; flex-wrap:wrap; }
    .queue-list-container { flex:1 1 220px; display:flex; flex-direction:column; gap:var(--anyai-space-3); overflow:hidden; }
    .queue-details { flex:1 1 220px; display:flex; flex-direction:column; gap:var(--anyai-space-3); }
    .queue-details textarea { flex:1; resize:vertical; font-family:var(--anyai-font-mono, 'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace); font-size:0.85rem; }
    .queue-details a { word-break:break-all; font-size:0.85rem; color:var(--anyai-primary-700); }
    .queue-controls { display:flex; flex-wrap:wrap; gap:var(--anyai-space-2); }
    .queue-item { border:1px solid var(--anyai-border); border-radius:var(--anyai-radius-2); padding:var(--anyai-space-3) var(--anyai-space-4); background:var(--anyai-panel); display:flex; flex-direction:column; gap:var(--anyai-space-2); cursor:pointer; }
    .queue-item.is-active { border-color:var(--anyai-primary-600); box-shadow:0 0 0 1px color-mix(in srgb, var(--anyai-primary), transparent 60%); }
    .queue-item-sub { display:flex; justify-content:space-between; gap:var(--anyai-space-2); color:var(--anyai-text-subtle); font-size:0.85rem; }
    .queue-item-type { font-size:0.75rem; color:var(--anyai-text-subtle); text-transform:uppercase; letter-spacing:0.04em; }
    .queue-status { display:inline-flex; align-items:center; gap:var(--anyai-space-2); padding:0 var(--anyai-space-2); border-radius:var(--anyai-radius-pill, 999px); font-size:0.75rem; text-transform:uppercase; letter-spacing:0.03em; }
    .queue-status-queued { background:var(--anyai-bg-subtle); color:var(--anyai-primary-700); }
    .queue-status-running { background:color-mix(in srgb, var(--anyai-success), transparent 82%); color:var(--anyai-success); }
    .queue-status-paused { background:color-mix(in srgb, var(--anyai-warning), transparent 80%); color:var(--anyai-warning); }
    .queue-status-cancelled { background:color-mix(in srgb, var(--anyai-danger), transparent 80%); color:var(--anyai-danger); }
    .queue-status-completed { background:var(--anyai-bg-subtle); color:var(--anyai-text-subtle); }

    .history-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:var(--anyai-space-2); }
    .history-list li { cursor:pointer; border:1px solid var(--anyai-border); border-radius:var(--anyai-radius-2); padding:var(--anyai-space-3) var(--anyai-space-4); transition:background .15s ease; }
    .history-list li:hover { background:var(--anyai-bg-subtle); }

    .field-inline { display:flex; align-items:center; gap:var(--anyai-space-3); }
    .field-inline label { font-weight:400; }

    .key-card {
      display: flex;
      flex-direction: column;
      gap: var(--anyai-space-5);
      background: var(--anyai-panel);
      border: 1px solid var(--anyai-border);
      border-radius: var(--anyai-radius-3);
      padding: var(--anyai-space-6);
    }

    .key-grid {
      display: grid;
      gap: var(--anyai-space-4);
    }

    @media (min-width: 720px) {
      .key-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .input-row {
      display: flex;
      align-items: center;
      gap: var(--anyai-space-2);
    }

    .input-row input[type="password"],
    .input-row input[type="text"] {
      flex: 1;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--anyai-space-2);
      padding: 0 var(--anyai-space-3);
      border-radius: var(--anyai-radius-pill, 999px);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .status-badge.is-ready {
      background: color-mix(in srgb, var(--anyai-success), white 88%);
      color: var(--anyai-success-900, var(--anyai-success));
    }

    .status-badge.is-missing {
      background: color-mix(in srgb, var(--anyai-danger), white 88%);
      color: var(--anyai-danger-900, var(--anyai-danger));
    }

    .message {
      padding: var(--anyai-space-3) var(--anyai-space-4);
      border-radius: var(--anyai-radius-2);
      font-size: 0.9rem;
      border: 1px solid transparent;
    }

    .message[data-state="success"] {
      background: color-mix(in srgb, var(--anyai-success), white 90%);
      color: var(--anyai-success-900, var(--anyai-success));
      border-color: color-mix(in srgb, var(--anyai-success), transparent 60%);
    }

    .message[data-state="error"] {
      background: color-mix(in srgb, var(--anyai-danger), white 90%);
      color: var(--anyai-danger-900, var(--anyai-danger));
      border-color: color-mix(in srgb, var(--anyai-danger), transparent 60%);
    }

    .message[data-state="info"] {
      background: var(--anyai-bg-subtle);
      color: var(--anyai-text-subtle);
      border-color: var(--anyai-border);
    }

    .model-grid {
      display: grid;
      gap: var(--anyai-space-4);
    }

    @media (min-width: 640px) {
      .model-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      #log-container { height: 240px; }
      .queue-content { flex-direction:column; }
    }
  </style>
</head>
<body>
    <div class="anyai-layout">
      <aside class="anyai-sidebar" data-active-tool="comment-enhancer"></aside>
      <main class="anyai-content">
      <div class="anyai-app">
        <section class="anyai-app-primary" aria-labelledby="enhancer-heading">
          <h1 id="enhancer-heading" class="mt-0">コメント改善をバッチ処理</h1>
          <p class="field-hint">スプレッドシートのコメント列を取り込み、指定モデルで改善案を生成します。</p>

          <form id="enhancer-form" class="anyai-form" aria-labelledby="enhancer-config-heading" autocomplete="off">
            <section class="key-card" aria-labelledby="key-heading">
              <div>
                <h2 id="key-heading" class="mt-0">APIキー設定</h2>
                <p class="field-hint">Comment Enhancer と関連機能で利用する OpenAI / Gemini のキーを管理します。</p>
              </div>
              <div class="key-grid">
                <div class="field" role="group" aria-labelledby="openai-key-label">
                  <div class="input-row">
                    <label id="openai-key-label" for="openai-key" class="text-strong">OpenAI API Key</label>
                    <span class="status-badge" data-status="openai">-</span>
                  </div>
                  <div class="input-row">
                    <input id="openai-key" name="openai-key" type="password" class="input" placeholder="sk-..." autocomplete="off">
                    <button type="button" class="btn btn-subtle" data-toggle-password="openai-key">表示</button>
                  </div>
                  <p class="field-hint">GPT 系列（gpt-4.1 / gpt-5-nano など）を利用する場合に必要です。</p>
                </div>
                <div class="field" role="group" aria-labelledby="gemini-key-label">
                  <div class="input-row">
                    <label id="gemini-key-label" for="gemini-key" class="text-strong">Gemini API Key</label>
                    <span class="status-badge" data-status="gemini">-</span>
                  </div>
                  <div class="input-row">
                    <input id="gemini-key" name="gemini-key" type="password" class="input" placeholder="AIza..." autocomplete="off">
                    <button type="button" class="btn btn-subtle" data-toggle-password="gemini-key">表示</button>
                  </div>
                  <p class="field-hint">Gemini Flash/Pro モデルを選択した場合に使用されます。</p>
                </div>
              </div>
              <div class="message" id="key-message" data-state="info">
                キーを入力し「保存」を押すと即時反映されます。.env に永続化する場合はチェックを付けてください。
              </div>
              <div class="field">
                <label class="checkbox">
                  <input type="checkbox" id="persist-keys">
                  <span>.env に保存して次回起動後も利用する</span>
                </label>
              </div>
              <div class="field field-inline">
                <button type="button" class="btn btn-primary" id="save-keys-button">保存</button>
                <button type="button" class="btn btn-outline" id="refresh-key-status">再読み込み</button>
              </div>
            </section>

            <section class="anyai-form-section" aria-labelledby="sheet-heading">
              <header>
                <h2 id="sheet-heading" class="mt-0">対象シート</h2>
                <p class="field-hint">URL と実行並列数を設定します。</p>
              </header>
              <div class="anyai-form-fields">
                <div class="field">
                  <label for="sheet-url">Google Spreadsheet URL / ID</label>
                  <p class="field-hint">共有可能な URL またはシート ID を貼り付けます。</p>
                  <input class="input" type="text" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." required>
                </div>
                <div class="field">
                  <label for="workers">並列処理数</label>
                  <p class="field-hint">同時実行するワーカー数（推奨: 50）。</p>
                  <input class="input" type="number" id="workers" value="50" min="1" max="200">
                  <details class="field-info">
                    <summary class="info-toggle"><span class="info-toggle-icon" aria-hidden="true">i</span><span>詳細</span></summary>
                    <div class="info-panel">429 対策が必要な場合は値を下げてください。最大 200 まで指定できます。</div>
                  </details>
                </div>
              </div>
            </section>

            <section class="anyai-form-section" aria-labelledby="model-heading">
              <header>
                <h2 id="model-heading" class="mt-0">モデル選択</h2>
                <p class="field-hint">Scoring UI と同じ選択肢からメインモデルを指定できます。</p>
              </header>
              <div class="model-grid">
                <div class="field">
                  <label for="model-select">利用モデル</label>
                  <select id="model-select" class="input">
                    <option value="gemini-flash-lite-latest">Gemini Flash Lite (latest)</option>
                    <option value="gemini-flash-latest">Gemini Flash (latest)</option>
                    <option value="gemini-pro-latest">Gemini Pro (latest)</option>
                    <option value="gpt-5-nano">GPT-5 Nano</option>
                    <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
                    <option value="gpt-4.1" selected>GPT-4.1</option>
                  </select>
                  <p class="field-hint">Gemini 系はテキスト生成に Gemini API、GPT 系は OpenAI API を利用します。</p>
                </div>
                <div class="field field-inline">
                  <button type="button" class="btn btn-outline" id="stop-button" disabled>停止</button>
                  <span class="field-hint">ジョブを即時停止します。</span>
                </div>
              </div>
            </section>
          </form>
        </section>

        <aside class="anyai-app-support">
          <section class="anyai-support-card">
            <div class="support-header">
              <h2 class="mt-0">最近のシート</h2>
            </div>
            <p class="field-hint" id="history-empty">実行履歴はまだありません。</p>
            <ul id="history-list" class="history-list"></ul>
          </section>

          <section class="anyai-support-card queue-card" id="queue-panel">
            <div class="queue-header">
              <h2 class="mt-0">キュー状況</h2>
              <div class="queue-header-actions">
                <button type="button" class="btn btn-text" data-queue-refresh>更新</button>
                <button type="button" class="btn btn-text" data-queue-toggle>折りたたむ</button>
              </div>
            </div>
            <div class="queue-content" data-queue-body>
              <div class="queue-list-container">
                <ul class="column gap-2" data-queue-list style="list-style:none; margin:0; padding:0; overflow-y:auto; max-height:240px;"></ul>
                <p class="text-subtle" data-queue-empty>待機中のジョブはありません。</p>
              </div>
              <div class="queue-details" data-queue-details hidden>
                <div>
                  <strong data-queue-title>(タイトル未取得)</strong><br>
                  <a href="#" target="_blank" data-queue-url></a>
                </div>
                <div>機能: <span data-queue-job-type>-</span></div>
                <div>状態: <span data-queue-status class="queue-status queue-status-queued">queued</span></div>
                <div>順番: <span data-queue-order>-</span></div>
                <div class="queue-controls">
                  <button type="button" class="btn btn-outline" data-queue-move-up>上へ</button>
                  <button type="button" class="btn btn-outline" data-queue-move-down>下へ</button>
                  <button type="button" class="btn btn-outline" data-queue-remove>削除</button>
                  <button type="button" class="btn btn-outline" data-queue-apply disabled title="現在のジョブ編集は未対応です">更新</button>
                </div>
                <textarea data-queue-json rows="6"></textarea>
              </div>
            </div>
          </section>

          <section class="anyai-support-card">
            <h2 class="mt-0">Execution Log</h2>
            <div id="log-container"><span class="text-subtle">Awaiting configuration...</span></div>
          </section>
        </aside>
      </div>
    </main>
  </div>

  <div class="anyai-action-bar" role="region" aria-label="コメント改善操作">
    <button type="button" class="btn btn-outline" id="btn-refresh-queue">再取得</button>
    <button type="submit" class="btn btn-primary" id="run-button" form="enhancer-form">実行</button>
  </div>

  <script>
    const loadingOverlay = window.AnyAILoading || {
      run: async (task) => task(),
      show: () => {},
      hide: () => {},
    };

    const form = document.getElementById('enhancer-form');
    const logContainer = document.getElementById('log-container');
    const runButton = document.getElementById('run-button');
    const stopButton = document.getElementById('stop-button');
    const sheetInput = document.getElementById('sheet-url');
    const historyList = document.getElementById('history-list');
    const historyEmpty = document.getElementById('history-empty');
    const queuePanel = document.getElementById('queue-panel');
    const refreshQueueButton = document.getElementById('btn-refresh-queue');
    const modelSelect = document.getElementById('model-select');
    const keySaveButton = document.getElementById('save-keys-button');
    const keyRefreshButton = document.getElementById('refresh-key-status');
    const keyMessage = document.getElementById('key-message');
    const persistCheckbox = document.getElementById('persist-keys');
    const keyInputs = {
      openai: document.getElementById('openai-key'),
      gemini: document.getElementById('gemini-key'),
    };
    const statusBadges = {
      openai: document.querySelector('[data-status="openai"]'),
      gemini: document.querySelector('[data-status="gemini"]'),
    };

    let currentProcessId = null;
    let eventSource = null;
    let isJobRunning = false;
    const keyStatus = { openai: false, gemini: false };
    const missingKeyNotice = { openai: false, gemini: false };

    const HISTORY_KEY = 'anyai_sheet_history_v3';
    const MAX_HISTORY = 10;

    function log(message, isError = false) {
      const timestamp = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.innerHTML = `<span class="text-subtle">[${timestamp}]</span> <span style="color:${isError ? 'var(--anyai-color-danger-700)' : 'inherit'};">${message}</span>`;
      logContainer.appendChild(line);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function setKeyMessage(text, state = 'info') {
      keyMessage.textContent = text;
      keyMessage.dataset.state = state;
    }

    function setStatusBadge(kind, ready) {
      const badge = statusBadges[kind];
      if (!badge) return;
      badge.textContent = ready ? '設定済み' : '未設定';
      badge.classList.toggle('is-ready', ready);
      badge.classList.toggle('is-missing', !ready);
    }

    function detectProvider(modelValue) {
      if (!modelValue) return 'openai';
      return modelValue.startsWith('gemini') ? 'gemini' : 'openai';
    }

    function updateRunButtonAvailability() {
      if (isJobRunning) {
        runButton.disabled = true;
        return;
      }
      const provider = detectProvider(modelSelect.value);
      if (provider === 'gemini') {
        runButton.disabled = !keyStatus.gemini;
      } else {
        runButton.disabled = !keyStatus.openai;
      }
    }

    function maybeLogMissing(provider) {
      if (keyStatus[provider]) {
        missingKeyNotice[provider] = false;
        return;
      }
      if (missingKeyNotice[provider]) return;
      if (provider === 'gemini') {
        log('-> Gemini APIキーが未設定です。上部の「APIキー設定」で登録してください。', true);
      } else {
        log('-> OpenAI APIキーが未設定です。上部の「APIキー設定」で登録してください。', true);
      }
      missingKeyNotice[provider] = true;
    }

    async function refreshKeyStatus(showLog = false) {
      try {
        const resp = await fetch('/settings');
        if (!resp.ok) throw new Error(`status ${resp.status}`);
        const data = await resp.json();
        keyStatus.openai = Boolean(data?.keys?.openai);
        keyStatus.gemini = Boolean(data?.keys?.gemini);
        setStatusBadge('openai', keyStatus.openai);
        setStatusBadge('gemini', keyStatus.gemini);
        setKeyMessage('キーを入力し「保存」を押すと即時反映されます。.env に永続化する場合はチェックを付けてください。', 'info');
        if (showLog) {
          log('-> APIキーの状態を更新しました。');
        }
      } catch (error) {
        setKeyMessage(`APIキー状態の取得に失敗しました: ${error.message}`, 'error');
        if (showLog) {
          log(`-> APIキー状態の取得に失敗: ${error}`, true);
        }
      } finally {
        updateRunButtonAvailability();
        maybeLogMissing(detectProvider(modelSelect.value));
      }
    }

    const queueManager = (window.AnyAIQueueManager && queuePanel)
      ? window.AnyAIQueueManager.init({ root: queuePanel, log })
      : null;

    function finalizeUI() {
      isJobRunning = false;
      updateRunButtonAvailability();
      runButton.textContent = '実行';
      stopButton.disabled = true;
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
      currentProcessId = null;
    }

    function parseSheetValue(value) {
      return (value || '').trim();
    }

    function loadHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      } catch (e) {
        return [];
      }
    }

    function saveHistory(items) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
    }

    function addToHistory(rawValue, title, status = 'queued') {
      const value = parseSheetValue(rawValue);
      if (!value) return;
      const items = loadHistory().filter(entry => entry.value !== value);
      title = (title || '').trim();
      items.unshift({ value, title, status, savedAt: new Date().toISOString() });
      if (items.length > MAX_HISTORY) items.length = MAX_HISTORY;
      saveHistory(items);
      renderHistory();
    }

    function renderHistory() {
      const items = loadHistory();
      historyList.innerHTML = '';
      if (!items.length) {
        historyEmpty.style.display = 'block';
        return;
      }
      historyEmpty.style.display = 'none';
      for (const entry of items) {
        const value = entry.value;
        const title = entry.title || '';
        const li = document.createElement('li');
        const displayTitle = title || '(シート名未取得)';
        li.innerHTML = `${displayTitle}<br><small class="text-subtle">状態: ${entry.status || 'queued'}</small>`;
        li.title = value;
        li.addEventListener('click', () => {
          sheetInput.value = value;
          sheetInput.focus();
        });
        historyList.appendChild(li);
      }
    }

    renderHistory();

    refreshKeyStatus(false);
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        refreshKeyStatus(false);
      }
    });

    if (refreshQueueButton) {
      refreshQueueButton.addEventListener('click', () => {
        if (queueManager && typeof queueManager.refresh === 'function') {
          queueManager.refresh();
        }
        renderHistory();
      });
    }

    document.querySelectorAll('[data-toggle-password]').forEach((button) => {
      button.addEventListener('click', () => {
        const targetId = button.dataset.togglePassword;
        const input = document.getElementById(targetId);
        if (!input) return;
        const hidden = input.type === 'password';
        input.type = hidden ? 'text' : 'password';
        button.textContent = hidden ? '隠す' : '表示';
      });
    });

    keySaveButton.addEventListener('click', async () => {
      const openaiValue = keyInputs.openai.value.trim();
      const geminiValue = keyInputs.gemini.value.trim();
      const persist = persistCheckbox.checked;

      if (!openaiValue && !geminiValue && !persist) {
        setKeyMessage('更新対象がありません。キーを入力するか、保存オプションを選択してください。', 'error');
        return;
      }

      const formData = new FormData();
      if (openaiValue) {
        formData.append('openai_api_key', openaiValue);
      }
      if (geminiValue) {
        formData.append('gemini_api_key', geminiValue);
      }
      if (persist) {
        formData.append('persist', 'true');
      }

      try {
        const resp = await fetch('/settings', { method: 'POST', body: formData });
        const result = await resp.json();
        if (!resp.ok) {
          const detail = result?.detail || result?.error || 'unknown error';
          throw new Error(detail);
        }

        keyInputs.openai.value = '';
        keyInputs.gemini.value = '';
        persistCheckbox.checked = false;
        setKeyMessage('APIキーを保存しました。処理にすぐ反映されます。', 'success');
        log('-> APIキーを保存しました。');
        await refreshKeyStatus(true);
      } catch (error) {
        setKeyMessage(`APIキーの保存に失敗しました: ${error.message}`, 'error');
        log(`-> APIキーの保存に失敗: ${error}`, true);
      }
    });

    keyRefreshButton.addEventListener('click', () => {
      setKeyMessage('最新の状態を取得中です...', 'info');
      refreshKeyStatus(true);
    });

    modelSelect.addEventListener('change', () => {
      updateRunButtonAvailability();
      maybeLogMissing(detectProvider(modelSelect.value));
    });

    stopButton.addEventListener('click', async () => {
      if (!currentProcessId) {
        log('-> 停止対象のジョブがありません。', true);
        return;
      }
      stopButton.disabled = true;
      log('-> 停止信号を送信します...');
      try {
        await fetch('/stop-analysis', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ process_id: currentProcessId }),
        });
        log('-> 停止信号を送信しました。');
      } catch (error) {
        log(`-> 停止リクエストでエラー: ${error}`, true);
      }
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const provider = detectProvider(modelSelect.value);
      if (provider === 'gemini' && !keyStatus.gemini) {
        log('-> Gemini モデルを使用するには Gemini APIキーが必要です。上部の設定で登録してください。', true);
        updateRunButtonAvailability();
        return;
      }
      if (provider === 'openai' && !keyStatus.openai) {
        log('-> GPT 系モデルを使用するには OpenAI APIキーが必要です。上部の設定で登録してください。', true);
        updateRunButtonAvailability();
        return;
      }

      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }

      const payload = {
        sheet_url: document.getElementById('sheet-url').value,
        workers: document.getElementById('workers').value,
        model_name: modelSelect.value,
        model_provider: provider,
      };

      logContainer.innerHTML = '';
      log('-> AnyAICommentEnhancer を開始します...');
      isJobRunning = true;
      updateRunButtonAvailability();
      runButton.textContent = '実行中...';
      stopButton.disabled = false;

      try {
        const resp = await loadingOverlay.run(() =>
          fetch('/run-comment-enhancer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
        );
        const result = await resp.json();
        if (!resp.ok) {
          const errorMessage = result.error || result.detail || result.message || 'Unknown error';
          log(`Error: ${errorMessage}`, true);
          finalizeUI();
          return;
        }

        currentProcessId = result.process_id;
        const jobSheetUrl = result.sheet_url || payload.sheet_url;
        const jobTitle = result.sheet_title;
        const jobParams = { ...payload };
        addToHistory(jobSheetUrl, jobTitle, 'queued');
        log(`-> Process ID: ${currentProcessId}`);

        if (queueManager) {
          queueManager.addJob({
            process_id: currentProcessId,
            status: result.status || 'queued',
            sheet_title: jobTitle,
            sheet_url: jobSheetUrl,
            params: jobParams,
            job_type: result.job_type,
          });
        }
        eventSource = new EventSource(`/stream-logs?process_id=${currentProcessId}`);
        eventSource.onmessage = (evt) => {
          log(evt.data);
        };
        eventSource.addEventListener('queue', (evt) => {
          try {
            const queuePayload = JSON.parse(evt.data);
            const status = queuePayload.status || 'queued';
            log(`-> ジョブ ${queuePayload.process_id} の状態: ${status}`);
            if (queueManager) {
              queueManager.handleQueueEvent(queuePayload);
            }
            if (queuePayload.process_id === currentProcessId) {
              addToHistory(queuePayload.sheet_url || jobSheetUrl, queuePayload.sheet_title || jobTitle, status);
              renderHistory();
            }
          } catch (error) {
            log(`-> キュー情報の解析に失敗: ${error}`, true);
          }
        });
        eventSource.addEventListener('error', (evt) => {
          if (evt.data) {
            log(`-> ${evt.data}`, true);
          } else {
            log('-> ログストリームが切断されました。', true);
          }
          finalizeUI();
          refreshKeyStatus(false);
        });
        eventSource.addEventListener('complete', (evt) => {
          log(`-> ${evt.data}`);
          addToHistory(jobSheetUrl, jobTitle, 'completed');
          if (queueManager) {
            queueManager.handleCompletion(currentProcessId);
          }
          renderHistory();
          finalizeUI();
        });
      } catch (error) {
        log(`Network or server error: ${error}`, true);
        refreshKeyStatus(false);
        finalizeUI();
      }
    });
  </script>
</body>
</html>
