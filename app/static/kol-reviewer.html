<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png">
<title>AnyAIKOLReviewer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/anyai/css/main.css" />
<script src="/static/anyai/loading-overlay.js"></script>
<script defer src="/static/anyai/vendor/lucide.js"></script>
<script defer src="/static/anyai/sidebar.js"></script>
<script defer src="/static/anyai/core/anyai.js"></script>
<script defer src="/static/anyai/queue-manager.js"></script>
<style>
  body { background: var(--anyai-app-bg, #f8f8fb); }

  .mode-options {
    display: inline-flex;
    align-items: center;
    gap: var(--anyai-space-2);
    flex-wrap: wrap;
  }

  .mode-pill {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--anyai-space-2);
    padding: 0.45rem 1rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 20%);
    background: linear-gradient(135deg,
      color-mix(in srgb, #ffffff, var(--anyai-border) 4%),
      color-mix(in srgb, #ffffff, var(--anyai-border) 12%)
    );
    color: color-mix(in srgb, var(--anyai-text), transparent 25%);
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease,
      box-shadow 0.2s ease, transform 0.15s ease;
    user-select: none;
  }

  .mode-pill input[type="radio"] {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    border: 0;
    clip: rect(0, 0, 0, 0);
    clip-path: inset(100%);
    overflow: hidden;
    white-space: nowrap;
  }

  .mode-pill span {
    font-size: var(--anyai-fs-2);
    line-height: 1;
  }

  .mode-pill:not([aria-checked="true"]) {
    border-color: color-mix(in srgb, var(--anyai-border), transparent 30%);
  }

  .mode-pill:not([aria-checked="true"]):hover {
    border-color: color-mix(in srgb, var(--anyai-border), var(--anyai-primary, #2955ff) 28%);
    color: color-mix(in srgb, var(--anyai-text), transparent 10%);
    background: linear-gradient(135deg,
      color-mix(in srgb, #ffffff, var(--anyai-primary, #2955ff) 12%),
      color-mix(in srgb, #ffffff, var(--anyai-primary, #2955ff) 20%)
    );
  }

  .mode-pill:focus-within {
    outline: none;
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--anyai-primary, #2955ff), transparent 75%);
  }

  .mode-pill[aria-checked="true"] {
    background: linear-gradient(135deg,
      color-mix(in srgb, var(--anyai-primary, #2955ff), white 12%),
      color-mix(in srgb, var(--anyai-primary, #2955ff), black 6%)
    );
    border-color: color-mix(in srgb, var(--anyai-primary, #2955ff), transparent 12%);
    color: #ffffff;
    box-shadow:
      0 0 0 3px color-mix(in srgb, var(--anyai-primary, #2955ff), transparent 80%),
      0 12px 28px rgba(41, 85, 255, 0.25);
    transform: translateY(-1px);
  }

  #history-list,
  .history-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-3);
  }

  #history-list li,
  .history-list li {
    cursor: pointer;
    border: 1px solid var(--anyai-border);
    border-radius: var(--anyai-radius-2);
    padding: var(--anyai-space-3) var(--anyai-space-4);
    transition: background 0.15s ease, border-color 0.15s ease;
  }

  #history-list li:hover {
    background: var(--anyai-bg-subtle);
    border-color: color-mix(in srgb, var(--anyai-border), var(--anyai-primary) 18%);
  }

  #log-container {
    height: 320px;
    overflow: auto;
    font-family: var(--anyai-font-mono);
    font-size: 0.9rem;
    white-space: pre-wrap;
    background: var(--anyai-surface-alt);
    padding: var(--anyai-space-4);
    border-radius: var(--anyai-radius-2);
    border: 1px solid var(--anyai-border);
  }

  .anyai-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--anyai-space-3);
    margin-top: var(--anyai-space-4);
  }

  .queue-card {
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-4);
  }

  .queue-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--anyai-space-3);
  }

  .queue-header-actions {
    display: flex;
    gap: var(--anyai-space-2);
  }

  .queue-content {
    display: flex;
    gap: var(--anyai-space-4);
    flex: 1;
    min-height: 220px;
  }

  .queue-list-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-3);
    overflow: hidden;
  }

  .queue-list-container ul {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-2);
    overflow-y: auto;
    max-height: 240px;
  }

  .queue-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-3);
  }

  .queue-details textarea {
    flex: 1;
    resize: vertical;
    font-family: var(--anyai-font-mono);
    font-size: 0.85rem;
  }

  .queue-details a {
    word-break: break-all;
    font-size: 0.85rem;
    color: var(--anyai-primary-700, #3348ff);
  }

  .queue-controls {
    display: flex;
    flex-wrap: wrap;
    gap: var(--anyai-space-2);
  }

  .queue-item {
    border: 1px solid var(--anyai-border);
    border-radius: var(--anyai-radius-2);
    padding: var(--anyai-space-3) var(--anyai-space-4);
    background: var(--anyai-panel, #fff);
    display: flex;
    flex-direction: column;
    gap: var(--anyai-space-2);
    cursor: pointer;
  }

  .queue-item.is-active {
    border-color: color-mix(in srgb, var(--anyai-primary), transparent 40%);
    box-shadow: 0 0 0 1px color-mix(in srgb, var(--anyai-primary), transparent 70%);
  }

  .queue-item-sub {
    display: flex;
    justify-content: space-between;
    gap: var(--anyai-space-2);
    color: var(--anyai-text-subtle);
    font-size: 0.85rem;
  }

  .queue-item-type {
    font-size: 0.75rem;
    color: var(--anyai-text-subtle);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .queue-status {
    display: inline-flex;
    align-items: center;
    gap: var(--anyai-space-2);
    padding: 0 var(--anyai-space-2);
    border-radius: var(--anyai-radius-pill);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .queue-status-queued { background: var(--anyai-color-info-100); color: var(--anyai-color-info-700); }
  .queue-status-running { background: var(--anyai-color-success-100); color: var(--anyai-color-success-700); }
  .queue-status-paused { background: var(--anyai-color-warning-100); color: var(--anyai-color-warning-800); }
  .queue-status-cancelled { background: var(--anyai-color-danger-100); color: var(--anyai-color-danger-700); }
  .queue-status-completed { background: var(--anyai-color-neutral-200); color: var(--anyai-color-neutral-700); }

  details.section-toggle > summary {
    display: flex;
    align-items: center;
    gap: var(--anyai-space-3);
    cursor: pointer;
    list-style: none;
  }

  details.section-toggle > summary::-webkit-details-marker { display: none; }

  .caret {
    margin-left: auto;
    display: inline-block;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid currentColor;
    opacity: 0.8;
    transition: transform 0.2s ease;
  }

  details.section-toggle:not(.section-toggle-left)[open] .caret { transform: rotate(180deg); }

  details.section-toggle-left > summary {
    gap: var(--anyai-space-3);
  }

  .section-toggle-left .caret {
    margin: 0;
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 8px solid currentColor;
    transform: rotate(-90deg);
    transform-origin: 50% 50%;
    transition: transform 0.2s ease;
  }

  .section-toggle-left[open] .caret {
    transform: rotate(0deg);
  }

  @media (max-width: 720px) {
    .anyai-form-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .anyai-form-actions .btn {
      width: 100%;
    }

    .queue-content {
      flex-direction: column;
    }

    #log-container {
      height: 240px;
    }
  }
</style>
</head>
<body>
  <div class="anyai-layout">
    <aside class="anyai-sidebar" data-active-tool="kol-reviewer"></aside>
    <main class="anyai-content">
      <div class="anyai-app">
        <section class="anyai-app-primary" aria-labelledby="kol-heading">
          <h1 id="kol-heading" class="mt-0 page-title-with-icon">
            <span class="page-title-icon" aria-hidden="true"><i data-lucide="users"></i></span>
            <span>AnyAIKOLReviewer</span>
          </h1>
          <p class="field-hint">`KOL_List` シートの調査メモとコメント列レンジから、KOLプロフィールとカテゴリを自動生成します。</p>

          <form id="kol-form" class="anyai-form" autocomplete="off">
            <section class="anyai-form-section" aria-labelledby="kol-basic-heading">
              <header>
                <h2 id="kol-basic-heading" class="mt-0">実行設定</h2>
                <p class="field-hint">対象スプレッドシートと行範囲、並列度を指定します。</p>
              </header>

              <div class="field">
                <label for="sheet-url">Google Spreadsheet URL / ID</label>
                <p class="field-hint">KOL一覧のシートURLまたはIDを入力してください。</p>
                <input class="input" type="text" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/... または シートID" required>
              </div>

              <div class="anyai-form-fields is-two-column">
                <div class="field">
                  <label for="start-row">開始行 (デフォルト: 2)</label>
                  <input class="input" type="number" id="start-row" value="2" min="2">
                </div>
                <div class="field">
                  <label for="end-row">終了行 (任意)</label>
                  <input class="input" type="number" id="end-row" placeholder="空欄で最後まで">
                </div>
                <div class="field">
                  <label id="kol-model-label">Gemini モデル</label>
                  <div class="mode-options" role="radiogroup" aria-labelledby="kol-model-label">
                    <label class="mode-pill" role="radio" aria-checked="true" tabindex="0">
                      <input type="radio" name="model-name" value="gemini-flash-latest" checked>
                      <span>Gemini Flash</span>
                    </label>
                    <label class="mode-pill" role="radio" aria-checked="false" tabindex="-1">
                      <input type="radio" name="model-name" value="gemini-pro-latest">
                      <span>Gemini Pro</span>
                    </label>
                  </div>
                </div>
                <div class="field">
                  <label for="workers">並列処理数</label>
                  <input class="input" type="number" id="workers" value="10" min="1" max="50">
                </div>
                <div class="field">
                  <label for="output-language">出力言語</label>
                  <select class="input" id="output-language">
                    <option value="Japanese" selected>日本語</option>
                    <option value="English">English</option>
                    <option value="Korean">한국어</option>
                    <option value="Thai">ภาษาไทย</option>
                    <option value="Vietnamese">Tiếng Việt</option>
                  </select>
                </div>
                <div class="field">
                  <label class="checkbox">
                    <input type="checkbox" id="debug-mode">
                    <span>デバッグモード（逐次処理＆エラー自動再実行ログ）</span>
                  </label>
                </div>
              </div>
            </section>

            <section class="anyai-form-section" aria-labelledby="kol-mapping-heading">
              <header>
                <h2 id="kol-mapping-heading" class="mt-0">シート &amp; 列設定</h2>
                <p class="field-hint">KOLメモ列やコメント列レンジ、出力列のマッピングを調整します。</p>
              </header>

              <div class="anyai-form-fields is-two-column">
                <div class="field">
                  <label for="source-sheet-name">シート名</label>
                  <input class="input" type="text" id="source-sheet-name" value="KOL_List">
                </div>
                <div class="field">
                  <label for="kol-col-letter">KOLメモ列</label>
                  <input class="input" type="text" id="kol-col-letter" value="C" maxlength="2">
                </div>
              </div>

              <details class="section-toggle section-toggle-left">
                <summary>
                  <span class="caret" aria-hidden="true"></span>
                  <span>列レンジ・出力列設定 (任意)</span>
                </summary>
                <div class="anyai-form-fields is-two-column" style="margin-top: var(--anyai-space-4);">
                  <div class="field">
                    <label for="reactions-start-col">反応開始列</label>
                    <input class="input" type="text" id="reactions-start-col" value="J" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="reactions-end-col">反応終了列</label>
                    <input class="input" type="text" id="reactions-end-col" value="S" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="profile-col-letter">プロフィール出力列</label>
                    <input class="input" type="text" id="profile-col-letter" value="D" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="risk-col-letter">リスク出力列</label>
                    <input class="input" type="text" id="risk-col-letter" value="E" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="trend-col-letter">傾向出力列</label>
                    <input class="input" type="text" id="trend-col-letter" value="F" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="content-category-col-letter">カテゴリ出力列</label>
                    <input class="input" type="text" id="content-category-col-letter" value="G" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="kol-tribe-col-letter">KOLトライブ列</label>
                    <input class="input" type="text" id="kol-tribe-col-letter" value="H" maxlength="2">
                  </div>
                  <div class="field">
                    <label for="batch-size">書き込みバッチ</label>
                    <input class="input" type="number" id="batch-size" value="30" min="1" max="200">
                  </div>
                </div>
              </details>
            </section>

            <div class="anyai-form-actions">
              <button type="button" class="btn btn-outline" id="stop-button" disabled>停止</button>
              <button type="submit" class="btn btn-primary" id="run-button">実行</button>
            </div>
          </form>
        </section>

        <aside class="anyai-app-support">
          <section class="anyai-support-card">
            <div class="support-header">
              <h2 class="mt-0">最近のシート</h2>
            </div>
            <p class="field-hint" id="history-empty">実行履歴はまだありません。</p>
            <ul id="history-list" class="history-list"></ul>
          </section>

          <section class="anyai-support-card queue-card" id="queue-panel">
            <div class="queue-header">
              <h2 class="mt-0">ジョブキュー</h2>
              <div class="queue-header-actions">
                <button type="button" class="btn btn-text" data-queue-refresh>更新</button>
                <button type="button" class="btn btn-text" data-queue-toggle>折りたたむ</button>
              </div>
            </div>
            <div data-queue-body>
              <div class="queue-content">
                <div class="queue-list-container">
                  <ul class="column gap-2" data-queue-list></ul>
                  <p class="text-subtle" data-queue-empty>待機中のジョブはありません。</p>
                </div>
                <div class="queue-details" data-queue-details hidden>
                  <div>
                    <strong data-queue-title>(タイトル未取得)</strong><br>
                    <a href="#" target="_blank" data-queue-url></a>
                  </div>
                  <div>機能: <span data-queue-job-type>-</span></div>
                  <div>状態: <span data-queue-status class="queue-status queue-status-queued">queued</span></div>
                  <div>順番: <span data-queue-order>-</span></div>
                  <div class="queue-controls">
                    <button type="button" class="btn btn-outline" data-queue-move-up>上へ</button>
                    <button type="button" class="btn btn-outline" data-queue-move-down>下へ</button>
                    <button type="button" class="btn btn-outline" data-queue-remove>削除</button>
                    <button type="button" class="btn btn-outline" data-queue-apply>更新</button>
                  </div>
                  <textarea data-queue-json rows="6"></textarea>
                </div>
              </div>
            </div>
          </section>

          <section class="anyai-support-card">
            <div class="support-header">
              <h2 class="mt-0">Execution Log</h2>
            </div>
            <div id="log-container"><span class="text-subtle">Awaiting configuration...</span></div>
          </section>
        </aside>
      </div>
    </main>
  </div>

<script>
  const loadingOverlay = window.AnyAILoading || {
    run: async (task) => task(),
    wrap: async (promise) => promise,
    show: () => {},
    hide: () => {},
    requireKeys: async () => true,
  };

  function setupModePills() {
    document.querySelectorAll('.mode-options').forEach((group) => {
      const pills = Array.from(group.querySelectorAll('.mode-pill'));
      if (!pills.length) return;
      const radios = pills.map((pill) => pill.querySelector('input[type="radio"]'));

      function sync() {
        pills.forEach((pill, index) => {
          const radio = radios[index];
          const checked = radio.checked;
          pill.setAttribute('aria-checked', checked ? 'true' : 'false');
          pill.tabIndex = checked ? 0 : -1;
        });
      }

      function activate(index, focus = true) {
        const radio = radios[index];
        if (radio.disabled) return;
        if (!radio.checked) {
          radio.checked = true;
          radio.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          sync();
        }
        if (focus) {
          pills[index].focus();
        }
      }

      pills.forEach((pill, index) => {
        const radio = radios[index];
        pill.addEventListener('click', (event) => {
          event.preventDefault();
          activate(index, false);
          sync();
        });

        pill.addEventListener('keydown', (event) => {
          let direction = 0;
          if (event.key === 'ArrowRight' || event.key === 'ArrowDown') direction = 1;
          if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') direction = -1;
          if (direction === 0) return;
          event.preventDefault();
          const total = pills.length;
          let next = index;
          do {
            next = (next + direction + total) % total;
          } while (radios[next].disabled && next !== index);
          activate(next);
          sync();
        });

        radio.addEventListener('change', sync);
      });

      sync();
    });
  }

  setupModePills();

  const form = document.getElementById('kol-form');
  const logContainer = document.getElementById('log-container');
  const runButton = document.getElementById('run-button');
  const stopButton = document.getElementById('stop-button');
  const sheetInput = document.getElementById('sheet-url');
  const historyList = document.getElementById('history-list');
  const historyEmpty = document.getElementById('history-empty');
  const queuePanel = document.getElementById('queue-panel');
  let currentProcessId = null;
  let eventSource = null;

  const HISTORY_KEY = 'anyai_sheet_history_v3';
  const MAX_HISTORY = 10;

  function log(message, isError = false) {
    const timestamp = new Date().toLocaleTimeString();
    const line = document.createElement('div');
    line.innerHTML = `<span class="text-subtle">[${timestamp}]</span> <span style="color:${isError ? 'var(--anyai-color-danger-700)' : 'inherit'};">${message}</span>`;
    logContainer.appendChild(line);
    logContainer.scrollTop = logContainer.scrollHeight;
  }

  const queueManager = (window.AnyAIQueueManager && queuePanel)
    ? window.AnyAIQueueManager.init({ root: queuePanel, log })
    : null;

  function finalizeUI() {
    runButton.disabled = false;
    runButton.textContent = '実行';
    stopButton.disabled = true;
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    currentProcessId = null;
  }

  function parseSheetValue(value) {
    return (value || '').trim();
  }

  function loadHistory() {
    try {
      return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    } catch (e) {
      return [];
    }
  }

  function saveHistory(items) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
  }

  function addToHistory(rawValue, title, status = 'queued') {
    const value = parseSheetValue(rawValue);
    if (!value) return;
    const items = loadHistory().filter(entry => entry.value !== value);
    title = (title || '').trim();
    items.unshift({ value, title, status, savedAt: new Date().toISOString() });
    if (items.length > MAX_HISTORY) items.length = MAX_HISTORY;
    saveHistory(items);
    renderHistory();
  }

  function renderHistory() {
    const items = loadHistory();
    historyList.innerHTML = '';
    if (!items.length) {
      historyEmpty.style.display = 'block';
      return;
    }
    historyEmpty.style.display = 'none';
    for (const entry of items) {
      const value = entry.value;
      const title = entry.title || '';
      const li = document.createElement('li');
      const displayTitle = title || '(シート名未取得)';
      li.innerHTML = `${displayTitle}<br><small class="text-subtle">状態: ${entry.status || 'queued'}</small>`;
      li.title = value;
      li.addEventListener('click', () => {
        sheetInput.value = value;
        sheetInput.focus();
      });
      historyList.appendChild(li);
    }
  }

  renderHistory();

  stopButton.addEventListener('click', async () => {
    if (!currentProcessId) {
      log('-> 停止対象のジョブがありません。', true);
      return;
    }
    stopButton.disabled = true;
    log('-> 停止信号を送信します...');
    try {
      await fetch('/stop-analysis', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: currentProcessId }),
      });
      log('-> 停止信号を送信しました。');
    } catch (error) {
      log(`-> 停止リクエストでエラー: ${error}`, true);
    }
  });

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }

    const payload = {
      sheet_url: document.getElementById('sheet-url').value,
      start_row: document.getElementById('start-row').value,
      end_row: document.getElementById('end-row').value,
      model_name: document.querySelector('input[name="model-name"]:checked').value,
      workers: document.getElementById('workers').value,
      output_language: document.getElementById('output-language').value,
      source_sheet_name: document.getElementById('source-sheet-name').value,
      kol_col_letter: document.getElementById('kol-col-letter').value,
      reactions_start_col: document.getElementById('reactions-start-col').value,
      reactions_end_col: document.getElementById('reactions-end-col').value,
      profile_col_letter: document.getElementById('profile-col-letter').value,
      risk_col_letter: document.getElementById('risk-col-letter').value,
      trend_col_letter: document.getElementById('trend-col-letter').value,
      content_category_col_letter: document.getElementById('content-category-col-letter').value,
      kol_tribe_col_letter: document.getElementById('kol-tribe-col-letter').value,
      batch_size: document.getElementById('batch-size').value,
      debug_mode: document.getElementById('debug-mode').checked,
    };

    logContainer.innerHTML = '';
    log('-> AnyAIKOLReviewer を開始します...');
    runButton.disabled = true;
    runButton.textContent = '実行中...';
    stopButton.disabled = false;

    try {
      const resp = await loadingOverlay.run(() =>
        fetch('/run-kol-reviewer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        })
      );
      const result = await resp.json();
      if (!resp.ok) {
        const errorMessage = result.error || result.detail || result.message || 'Unknown error';
        log(`Error: ${errorMessage}`, true);
        finalizeUI();
        return;
      }

      currentProcessId = result.process_id;
      const jobSheetUrl = result.sheet_url || payload.sheet_url;
      const jobTitle = result.sheet_title;
      const jobParams = { ...payload };
      addToHistory(jobSheetUrl, jobTitle, 'queued');
      log(`-> Process ID: ${currentProcessId}`);

      if (queueManager) {
        queueManager.addJob({
          process_id: currentProcessId,
          status: result.status || 'queued',
          sheet_title: jobTitle,
          sheet_url: jobSheetUrl,
          params: jobParams,
          job_type: result.job_type,
        });
      }

      eventSource = new EventSource(`/stream-logs?process_id=${currentProcessId}`);
      eventSource.onmessage = (evt) => log(evt.data);
      eventSource.addEventListener('queue', (evt) => {
        try {
          const queuePayload = JSON.parse(evt.data);
          const status = queuePayload.status || 'queued';
          log(`-> ジョブ ${queuePayload.process_id} の状態: ${status}`);
          if (queueManager) {
            queueManager.handleQueueEvent(queuePayload);
          }
          if (queuePayload.process_id === currentProcessId) {
            addToHistory(queuePayload.sheet_url || jobSheetUrl, queuePayload.sheet_title || jobTitle, status);
            renderHistory();
          }
        } catch (error) {
          log(`-> キュー情報の解析に失敗: ${error}`, true);
        }
      });
      eventSource.addEventListener('error', (evt) => {
        if (evt.data) {
          log(`-> ${evt.data}`, true);
        } else {
          log('-> ログストリームが切断されました。', true);
        }
        finalizeUI();
      });
      eventSource.addEventListener('complete', (evt) => {
        log(`-> ${evt.data}`);
        addToHistory(jobSheetUrl, jobTitle, 'completed');
        if (queueManager) {
          queueManager.handleCompletion(currentProcessId);
        }
        renderHistory();
        finalizeUI();
      });
    } catch (error) {
      log(`Network or server error: ${error}`, true);
      finalizeUI();
    }
  });
</script>
</body>
</html>
