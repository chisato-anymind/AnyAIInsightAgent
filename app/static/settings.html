<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="/static/anyai/assets/AnyAI_Logo_For_Loading.png">
  <title>AnyAI Settings</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/anyai/css/main.css" />
  <script defer src="/static/anyai/vendor/lucide.js"></script>
  <script defer src="/static/anyai/sidebar.js"></script>
  <script defer src="/static/anyai/core/anyai.js"></script>
  <style>
    .settings-grid {
      display: grid;
      gap: var(--anyai-space-4);
      width: 100%;
    }

    @media (min-width: 720px) {
      .settings-grid {
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      }
    }

    .field-block {
      display: flex;
      flex-direction: column;
      gap: var(--anyai-space-2);
    }

    .input-row {
      display: flex;
      gap: var(--anyai-space-2);
      align-items: center;
      width: 100%;
      flex-wrap: wrap;
      box-sizing: border-box;
    }

    .input-row input[type="password"],
    .input-row input[type="text"] {
      flex: 1;
      min-width: 0;
    }

    .input-row .btn {
      flex: 0 0 auto;
      white-space: nowrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--anyai-space-2);
      padding: 0 var(--anyai-space-3);
      border-radius: var(--anyai-radius-pill, 999px);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .status-badge.is-ready {
      background: color-mix(in srgb, var(--anyai-success), white 88%);
      color: var(--anyai-success-900, var(--anyai-success));
    }

    .status-badge.is-missing {
      background: color-mix(in srgb, var(--anyai-danger), white 88%);
      color: var(--anyai-danger-900, var(--anyai-danger));
    }

    .message {
      padding: var(--anyai-space-3) var(--anyai-space-4);
      border-radius: var(--anyai-radius-2);
      font-size: 0.9rem;
      border: 1px solid transparent;
    }

    .message[data-state="success"] {
      background: color-mix(in srgb, var(--anyai-success), white 90%);
      color: var(--anyai-success-900, var(--anyai-success));
      border-color: color-mix(in srgb, var(--anyai-success), transparent 60%);
    }

    .message[data-state="error"] {
      background: color-mix(in srgb, var(--anyai-danger), white 90%);
      color: var(--anyai-danger-900, var(--anyai-danger));
      border-color: color-mix(in srgb, var(--anyai-danger), transparent 60%);
    }

    .message[data-state="info"] {
      background: var(--anyai-bg-subtle);
      color: var(--anyai-text-subtle);
      border-color: var(--anyai-border);
    }

    .input-key {
      font-family: var(--anyai-font-mono, 'Roboto Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace);
      white-space: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .input-key::-webkit-scrollbar {
      height: 6px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      width: 100%;
      box-sizing: border-box;
    }

    .row > * {
      flex: 0 0 auto;
    }
  </style>
</head>
<body>
  <div class="anyai-layout">
    <aside class="anyai-sidebar" data-active-tool="settings-api"></aside>
    <main class="anyai-content">
      <div class="anyai-app">
        <section class="anyai-app-primary" aria-labelledby="settings-heading">
          <h1 id="settings-heading" class="mt-0 page-title-with-icon">
            <span class="page-title-icon" aria-hidden="true"><i data-lucide="key"></i></span>
            <span>APIキー設定</span>
          </h1>
          <p class="field-hint">Comment Enhancer や動画スイート機能で利用する OpenAI / Gemini の APIキーを管理します。</p>

          <form id="keys-form" class="anyai-form" autocomplete="off">
            <section class="anyai-form-section" aria-labelledby="section-keys">
              <header>
                <h2 id="section-keys" class="mt-0">キーの状態</h2>
                <p class="field-hint">キーはサーバープロセスの環境変数として登録され、任意で <code>.env</code> に保存できます。</p>
              </header>

              <div class="settings-grid" role="list">
                <div class="field-block" role="listitem">
                  <div class="input-row">
                    <label for="openai-key" class="text-strong">OpenAI API Key</label>
                    <span class="status-badge" data-status="openai">-</span>
                  </div>
                  <div class="input-row">
                    <input id="openai-key" name="openai-key" type="password" autocomplete="off" placeholder="sk-..." class="input input-key">
                    <button type="button" class="btn btn-subtle" data-toggle-password="openai-key">表示</button>
                  </div>
                  <p class="field-hint">例: <code>gpt-4.1</code> 系列を利用するには有効な OpenAI APIキーが必要です。</p>
                </div>

                <div class="field-block" role="listitem">
                  <div class="input-row">
                    <label for="gemini-key" class="text-strong">Gemini API Key</label>
                    <span class="status-badge" data-status="gemini">-</span>
                  </div>
                  <div class="input-row">
                    <input id="gemini-key" name="gemini-key" type="password" autocomplete="off" placeholder="AIza..." class="input input-key">
                    <button type="button" class="btn btn-subtle" data-toggle-password="gemini-key">表示</button>
                  </div>
                  <p class="field-hint">動画分析・レビュー機能では Gemini Flash / Pro モデルが使用されます。</p>
                </div>
              </div>

              <label class="checkbox">
                <input type="checkbox" id="persist-keys">
                <span>保存して再起動後も利用する（<code>.env</code> に書き込み）</span>
              </label>
              <div class="message" id="status-message" data-state="info">
                キーを入力して「保存」を押すと即座に反映されます。
              </div>
              <div class="row gap-3">
                <button type="submit" class="btn btn-primary">保存</button>
                <button type="button" class="btn btn-outline" id="refresh-status">再読み込み</button>
              </div>
            </section>
          </form>
        </section>

        <aside class="anyai-app-support">
          <section class="anyai-support-card">
            <div class="support-header">
              <h2 class="mt-0">ヘルプ</h2>
            </div>
            <ul class="list-disc">
              <li>OpenAIキーが未設定の場合、Comment Enhancer は実行できません。</li>
              <li>キーを更新した後は自動的に全ワーカープロセスへ反映されます。</li>
              <li>誤ったキーで保存した場合は空欄のまま再度保存し、正しいキーを入力してください。</li>
            </ul>
          </section>
        </aside>
      </div>
    </main>
  </div>

  <script>
    const statusBadges = {
      openai: document.querySelector('[data-status="openai"]'),
      gemini: document.querySelector('[data-status="gemini"]'),
    };
    const messageEl = document.getElementById('status-message');
    const formEl = document.getElementById('keys-form');
    const persistEl = document.getElementById('persist-keys');
    const refreshBtn = document.getElementById('refresh-status');
    const inputs = {
      openai: document.getElementById('openai-key'),
      gemini: document.getElementById('gemini-key'),
    };
    const toggleButtons = {};

    Object.values(inputs).forEach((input) => {
      if (!input) return;
      input.dataset.visibility = 'hidden';
      input.dataset.hasMaskedOnly = 'false';
      input.dataset.masked = '';
      input.addEventListener('input', () => {
        input.dataset.hasMaskedOnly = 'false';
      });
    });

    const STATUS_TEXT = {
      ready: '設定済み',
      missing: '未設定',
    };

    function setMessage(text, state = 'info') {
      messageEl.textContent = text;
      messageEl.dataset.state = state;
    }

    function setStatusBadge(kind, isReady) {
      const badge = statusBadges[kind];
      if (!badge) return;
      badge.textContent = isReady ? STATUS_TEXT.ready : STATUS_TEXT.missing;
      badge.classList.toggle('is-ready', isReady);
      badge.classList.toggle('is-missing', !isReady);
    }

    function applyKeyField(kind, info) {
      const input = inputs[kind];
      if (!input) return;
      const button = toggleButtons[input.id];
      const masked = info.masked || '';
      const shouldStayVisible = input.dataset.visibility === 'visible' && Boolean(masked);

      input.dataset.masked = masked;
      if (masked) {
        input.dataset.hasMaskedOnly = 'true';
      } else {
        input.dataset.hasMaskedOnly = 'false';
      }

      if (shouldStayVisible) {
        input.type = 'text';
        input.value = masked;
        input.dataset.visibility = 'visible';
        if (button) button.textContent = '隠す';
      } else {
        input.dataset.visibility = 'hidden';
        input.type = 'password';
        input.value = masked || '';
        if (button) button.textContent = '表示';
      }

      if (!masked) {
        input.value = '';
        if (button) button.textContent = '表示';
      }

      input.scrollLeft = 0;
    }

    function parseKeyInfo(info) {
      if (info && typeof info === 'object' && 'ready' in info) {
        return {
          ready: Boolean(info.ready),
          masked: typeof info.masked === 'string' ? info.masked : '',
        };
      }
      return {
        ready: Boolean(info),
        masked: '',
      };
    }

    async function fetchStatus() {
      try {
        const resp = await fetch('/settings/status');
        if (!resp.ok) {
          throw new Error(`status ${resp.status}`);
        }
        const data = await resp.json();
        const keys = data?.keys || {};
        const openaiInfo = parseKeyInfo(keys.openai);
        const geminiInfo = parseKeyInfo(keys.gemini);
        setStatusBadge('openai', openaiInfo.ready);
        applyKeyField('openai', openaiInfo);
        setStatusBadge('gemini', geminiInfo.ready);
        applyKeyField('gemini', geminiInfo);
        setMessage('最新のキー状態を取得しました。', 'info');
      } catch (error) {
        console.error(error);
        setMessage(`キー状態の取得に失敗しました: ${error.message}`, 'error');
      }
    }

    formEl.addEventListener('submit', async (event) => {
      event.preventDefault();
      const openaiValue = inputs.openai.value.trim();
      const geminiValue = inputs.gemini.value.trim();
      const persist = persistEl.checked;

      if (!openaiValue && !geminiValue && !persist) {
        setMessage('更新対象がありません。キーを入力するか、保存オプションを選択してください。', 'error');
        return;
      }

      const formData = new FormData();
      if (openaiValue) {
        formData.append('openai_api_key', openaiValue);
      }
      if (geminiValue) {
        formData.append('gemini_api_key', geminiValue);
      }
      if (persist) {
        formData.append('persist', 'true');
      }

      try {
        const resp = await fetch('/settings', {
          method: 'POST',
          body: formData,
        });
        const result = await resp.json();
        if (!resp.ok) {
          const detail = result?.detail || result?.error || 'unknown error';
          throw new Error(detail);
        }

        inputs.openai.value = '';
        inputs.openai.dataset.masked = '';
        inputs.openai.dataset.hasMaskedOnly = 'false';
        inputs.openai.dataset.visibility = 'hidden';
        if (toggleButtons[inputs.openai.id]) {
          toggleButtons[inputs.openai.id].textContent = '表示';
        }

        inputs.gemini.value = '';
        inputs.gemini.dataset.masked = '';
        inputs.gemini.dataset.hasMaskedOnly = 'false';
        inputs.gemini.dataset.visibility = 'hidden';
        if (toggleButtons[inputs.gemini.id]) {
          toggleButtons[inputs.gemini.id].textContent = '表示';
        }

        persistEl.checked = false;

        setMessage('APIキーを保存しました。すぐに反映されます。', 'success');
        await fetchStatus();
      } catch (error) {
        console.error(error);
        setMessage(`APIキーの保存に失敗しました: ${error.message}`, 'error');
      }
    });

    refreshBtn.addEventListener('click', () => {
      fetchStatus();
    });

    document.querySelectorAll('[data-toggle-password]').forEach((button) => {
      const targetId = button.dataset.togglePassword;
      if (targetId) {
        toggleButtons[targetId] = button;
      }
      button.addEventListener('click', () => {
        const input = document.getElementById(targetId);
        if (!input) return;
        const isCurrentlyVisible = input.dataset.visibility === 'visible';
        if (isCurrentlyVisible) {
          input.type = 'password';
          input.dataset.visibility = 'hidden';
          if (input.dataset.hasMaskedOnly === 'true') {
            input.value = input.dataset.masked || '';
          }
          button.textContent = '表示';
          input.scrollLeft = 0;
        } else {
          input.type = 'text';
          input.dataset.visibility = 'visible';
          if (input.dataset.hasMaskedOnly === 'true') {
            input.value = input.dataset.masked || '';
          }
          button.textContent = '隠す';
          requestAnimationFrame(() => {
            input.scrollLeft = input.scrollWidth;
          });
        }
      });
    });

    fetchStatus();
  </script>
</body>
</html>
