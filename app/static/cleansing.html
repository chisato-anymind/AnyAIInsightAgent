<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>AnyAI Cleansing — データクレンジングAIエージェント</title>
    <link rel="icon" href="/static/anyai/assets/AnyAI_icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/anyai/core/anyai.tokens.css" />
    <link rel="stylesheet" href="/static/anyai/core/anyai.components.css" />
    <link rel="stylesheet" href="/static/anyai/core/anyai.utilities.css" />
    <link rel="stylesheet" href="/static/anyai/tool-layout.css" />
    <script defer src="/static/anyai/vendor/lucide.js"></script>
    <script defer src="/static/anyai/sidebar.js"></script>
    <style>
      input[type="text"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: var(--anyai-radius-2);
        border: 1px solid color-mix(in srgb, var(--anyai-border), transparent 30%);
        background: var(--anyai-panel);
        font: inherit;
      }

      .stack-sm { display: flex; flex-direction: column; gap: var(--anyai-space-3); }
      .muted { color: var(--anyai-text-subtle); font-size: var(--anyai-fs-2); }
      progress { width: 100%; height: 12px; border-radius: var(--anyai-radius-2); overflow: hidden; }
      ul.error-list { margin: 0; padding-left: 18px; }
      ul.error-list li { word-break: break-word; }
    </style>
  </head>
  <body>
    <div class="anyai-layout">
      <aside class="anyai-sidebar" data-active-tool="cleansing"></aside>
      <main class="anyai-content">
        <div class="anyai-app">
          <section class="anyai-app-primary" aria-labelledby="cleansing-heading">
            <h1 id="cleansing-heading" class="mt-0 page-title-with-icon">
              <span class="page-title-icon" aria-hidden="true"><i data-lucide="wand-2"></i></span>
              <span>Related列を自動クレンジング</span>
            </h1>
            <p class="field-hint">content と Related 列を含むシートを指定すると、重複や欠損を整理した関連語リストを生成します。</p>

            <div class="anyai-form" aria-labelledby="cleansing-config-heading">
              <section class="anyai-form-section" aria-labelledby="input-heading">
                <header>
                  <h2 id="input-heading" class="mt-0">入力設定</h2>
                  <p class="field-hint">処理対象のシート情報とクリーニング条件を入力します。</p>
                </header>
                <form id="cleansing-form">
                  <div class="anyai-form-fields">
                    <div class="field">
                      <label for="sheet">SheetID / SheetURL</label>
                      <p class="field-hint">対象GoogleスプレッドシートのURLまたはID。</p>
                      <input type="text" id="sheet" name="sheet" placeholder="https://docs.google.com/spreadsheets/d/..." required />
                    </div>
                    <div class="field">
                      <label for="country">Country</label>
                      <p class="field-hint">クリーニングに利用する地域コード。</p>
                      <input type="text" id="country" name="country" placeholder="例: 日本" required />
                    </div>
                    <div class="field">
                      <label for="product_category">Product Category</label>
                      <p class="field-hint">商材カテゴリを一語で記入します。</p>
                      <input type="text" id="product_category" name="product_category" placeholder="例: ガム" required />
                    </div>
                    <div class="field">
                      <label for="sheet_name">Sheet Name</label>
                      <p class="field-hint">content と Related 列を含むシート名。</p>
                      <input type="text" id="sheet_name" name="sheet_name" value="RawData_Master" required />
                      <details class="field-info">
                        <summary class="info-toggle"><span class="info-toggle-icon" aria-hidden="true">i</span><span>詳細</span></summary>
                        <div class="info-panel">ヘッダーに <code>content</code> と <code>Related</code> が含まれているシートを指定してください。</div>
                      </details>
                    </div>
                  </div>
                </form>
              </section>
            </div>
          </section>

          <aside class="anyai-app-support">
            <section id="job-section" class="anyai-support-card" style="display:none;">
              <div class="stack-sm">
                <div>ジョブID: <code id="job-id"></code></div>
                <div class="muted" id="job-status"></div>
                <progress id="job-progress" value="0" max="100"></progress>
                <div class="muted" id="job-counts"></div>
                <div id="job-message"></div>
                <div id="job-errors" style="display:none;">
                  <h2 class="mt-0" style="margin:0; font-size: var(--anyai-fs-3);">エラー詳細</h2>
                  <ul class="error-list" id="job-error-list"></ul>
                </div>
              </div>
            </section>
          </aside>
        </div>
      </main>
    </div>

    <div class="anyai-action-bar" role="region" aria-label="クレンジング操作">
      <button type="button" class="btn btn-outline" id="btn-refresh-status">再取得</button>
      <button type="submit" class="btn btn-primary" form="cleansing-form">実行</button>
    </div>

    <script>
      const form = document.getElementById('cleansing-form');
      const jobSection = document.getElementById('job-section');
      const jobIdEl = document.getElementById('job-id');
      const jobStatusEl = document.getElementById('job-status');
      const jobCountsEl = document.getElementById('job-counts');
      const jobMessageEl = document.getElementById('job-message');
      const progressEl = document.getElementById('job-progress');
      const errorBox = document.getElementById('job-errors');
      const errorList = document.getElementById('job-error-list');

      let currentJobId = null;
      let pollTimer = null;

      function stopPolling() {
        if (pollTimer) {
          clearTimeout(pollTimer);
          pollTimer = null;
        }
      }

      async function fetchStatus(jobId) {
        const res = await fetch(`/cleansing/jobs/${jobId}`);
        if (!res.ok) throw new Error('ステータス取得に失敗しました');
        return res.json();
      }

      function renderStatus(state) {
        jobSection.style.display = 'block';
        jobIdEl.textContent = state.job_id;
        jobStatusEl.textContent = `ステータス: ${state.status}`;
        jobMessageEl.textContent = state.message || '';
        const total = state.total_items || 0;
        const processed = state.processed_items || 0;
        const success = state.success_count || 0;
        const fallback = state.fallback_count || 0;
        const failure = state.failure_count || 0;
        progressEl.value = total ? Math.floor((processed / total) * 100) : 0;
        jobCountsEl.textContent = `対象 ${total} 件 / 処理済み ${processed} 件 (成功 ${success}, フォールバック ${fallback}, 失敗 ${failure})`;

        const errors = state.errors || [];
        if (errors.length) {
          errorBox.style.display = 'block';
          errorList.innerHTML = '';
          errors.slice(0, 20).forEach((err) => {
            const li = document.createElement('li');
            li.textContent = `row ${err.row_number}: ${err.reason}`;
            errorList.appendChild(li);
          });
          if (errors.length > 20) {
            const li = document.createElement('li');
            li.textContent = `… 残り ${errors.length - 20} 件`; 
            errorList.appendChild(li);
          }
        } else {
          errorBox.style.display = 'none';
          errorList.innerHTML = '';
        }

        const stillRunning = state.status === 'pending' || state.status === 'running';
        if (stillRunning) {
          pollTimer = setTimeout(() => pollStatus(currentJobId), 2000);
        } else {
          stopPolling();
        }
      }

      async function pollStatus(jobId) {
        try {
          const state = await fetchStatus(jobId);
          renderStatus(state);
        } catch (err) {
          console.error(err);
          jobStatusEl.textContent = 'ステータス取得に失敗しました';
          stopPolling();
        }
      }

      document.getElementById('btn-refresh-status').addEventListener('click', () => {
        if (currentJobId) {
          pollStatus(currentJobId);
        } else {
          alert('現在アクティブなジョブはありません');
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        stopPolling();
        const fd = new FormData(form);
        const res = await fetch('/cleansing/jobs', { method: 'POST', body: fd });
        if (!res.ok) {
          alert('ジョブの作成に失敗しました');
          return;
        }
        const data = await res.json();
        currentJobId = data.job_id;
        jobSection.style.display = 'block';
        progressEl.value = 0;
        jobStatusEl.textContent = 'ステータス: pending';
        jobMessageEl.textContent = 'ジョブを開始しました。';
        jobCountsEl.textContent = '';
        errorList.innerHTML = '';
        errorBox.style.display = 'none';
        pollStatus(currentJobId);
      });
    </script>
  </body>
</html>
